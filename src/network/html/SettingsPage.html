<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrossPoint Reader - Settings</title>
  <style>
  body {
      --font-color: #333;
      --background: #f5f5f5;
      --title-color: #2c3e50;
      --card-background: white;
      --label-color: #7f8c8d;
      --status-ok: #27ae60;
      --border-color: #eee;
      --accent-color: #6e9a82;

      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Oxygen, Ubuntu, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--background);
      color: var(--font-color);
      font-size: 16px;
    }
    @media (prefers-color-scheme: dark) {
      body {
        --font-color: #f5f5f5;
        --background: #333;
        --title-color: #ecf0f1;
        --card-background: #444;
        --label-color: #bdc3c7;
        --border-color: #555;

        color-scheme: dark;
      }
    }
    h1 {
      margin-top: 0;
      color: var(--title-color);
      display: flex;
      gap: 8px;
      font-size: 24px;
      align-items: center;
      padding-bottom: 10px;
    }
    h1 .logo {
      background-color: #6e9a82;
      padding: 0 4px;
      border-radius: 4px;
    }
    h1 .logo svg {
      width: 18px;
      height: 18px;
    }
    h2 {
      color: var(--title-color);
      margin-top: 0;
      font-size: 20px;
    }
    .card {
      background: var(--card-background);
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card h3 {
      margin: 0;
      color: var(--title-color);
      font-size: 18px;
      padding-bottom: 8px;
    }
    .nav-links {
      margin: 20px 0 15px;
      border-bottom: solid 2px var(--border-color);
      display: flex;
      gap: 8px;
      padding-bottom: 8px;
    }
    .nav-links a {
      padding: 8px 15px;
      font-size: 0.85em;
      color: var(--font-color);
      text-decoration: none;
      border-radius: 4px;
    }
    .nav-links a.active {
      color: var(--font-color);
      text-decoration: none;
      background: var(--accent-color);
    }
    .nav-links a:not(.active):hover {
      color: var(--font-color);
      text-decoration: none;
      background: var(--border-color);
    }
    a {
      color: var(--accent-color);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .setting-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .setting-name {
      color: var(--title-color);
      flex: 1;
      min-width: 0;
      padding-right: 12px;
    }
    .setting-control {
      flex-shrink: 0;
    }
    .setting-control select,
    .setting-control input[type="number"],
    .setting-control input[type="text"],
    .setting-control input[type="password"] {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.95em;
    }
    .setting-control select {
      min-width: 160px;
    }
    .setting-control input[type="text"],
    .setting-control input[type="password"] {
      width: 220px;
    }
    .setting-control input[type="number"] {
      width: 80px;
    }
    /* Toggle switch */
    .toggle-switch {
      display: inline-block;
      position: relative;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      border-radius: 26px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: #27ae60;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .save-container {
      text-align: center;
      margin: 20px 0;
    }
    .save-btn {
      background-color: #27ae60;
      color: white;
      padding: 12px 40px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
    }
    .save-btn:hover {
      background-color: #219a52;
    }
    .save-btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .message {
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      text-align: center;
      display: none;
    }
    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .loader-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #AAA;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      body {
        padding: 10px;
        font-size: 14px;
      }
      .card {
        padding: 12px;
        margin: 10px 0;
      }
      h1 {
        font-size: 1.3em;
      }
      .nav-links a {
        padding: 8px 12px;
        margin-right: 6px;
        font-size: 0.9em;
      }
      .setting-row {
        flex-wrap: wrap;
        gap: 6px;
      }
      .setting-control select,
      .setting-control input[type="text"],
      .setting-control input[type="password"] {
        min-width: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>
    <span class="logo">
      <svg viewBox="0 0 162 180" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M141.133 1.93774C150.102 -3.44192 161.517 3.01665 161.521 13.4749V166.526C161.517 176.984 150.102 183.442 141.133 178.063L80.7588 141.837L20.3867 178.063C11.4176 183.442 0.00328866 176.984 0 166.526V13.4749C0.00337257 3.01685 11.4176 -3.44137 20.3867 1.93774L80.7598 38.1614L141.133 1.93774ZM121.275 117.524L92.3848 134.864L147.281 167.811C148.277 168.408 149.542 167.685 149.545 166.526V100.567L121.275 117.524ZM14.2393 12.1897C13.2438 11.5924 11.979 12.3152 11.9756 13.4749V86.6125L74.7725 124.29V48.51L14.2393 12.1897Z" fill="black"/>
      </svg>
    </span>
    CrossPoint Reader
  </h1>

  <div class="nav-links">
    <a href="/">Home</a>
    <a href="/files">File Manager</a>
    <a href="/settings" class="active">Settings</a>
  </div>

  <h2>Settings</h2>

  <div id="message" class="message"></div>

  <div id="settings-container">
    <div class="loader-container">
      <span class="loader"></span>
    </div>
  </div>

  <div class="save-container" id="save-container" style="display:none;">
    <button class="save-btn" id="saveBtn" onclick="saveSettings()">Save Settings</button>
  </div>

  <footer>
    <a
      href="https://github.com/crosspoint-reader/crosspoint-reader"
      target="_blank"
      >CrossPoint E-Reader â€¢ Open Source</a
    >
  </footer>

<script>
  let allSettings = [];
  let originalValues = {};

  function escapeHtml(unsafe) {
    return unsafe
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function showMessage(text, isError) {
    const msg = document.getElementById('message');
    msg.textContent = text;
    msg.className = 'message ' + (isError ? 'error' : 'success');
    msg.style.display = 'block';
    setTimeout(function() { msg.style.display = 'none'; }, 4000);
  }

  function renderControl(setting) {
    const id = 'setting-' + setting.key;

    if (setting.type === 'toggle') {
      const checked = setting.value ? 'checked' : '';
      return '<label class="toggle-switch">' +
        '<input type="checkbox" id="' + id + '" ' + checked + ' onchange="markChanged()">' +
        '<span class="toggle-slider"></span></label>';
    }

    if (setting.type === 'enum') {
      let html = '<select id="' + id + '" onchange="markChanged()">';
      setting.options.forEach(function(opt, idx) {
        const selected = idx === setting.value ? ' selected' : '';
        html += '<option value="' + idx + '"' + selected + '>' + escapeHtml(opt) + '</option>';
      });
      html += '</select>';
      return html;
    }

    if (setting.type === 'value') {
      return '<input type="number" id="' + id + '" value="' + setting.value + '"' +
        ' min="' + setting.min + '" max="' + setting.max + '" step="' + setting.step + '"' +
        ' onchange="markChanged()">';
    }

    if (setting.type === 'string') {
      const inputType = setting.name.toLowerCase().includes('password') ? 'password' : 'text';
      const val = setting.value || '';
      return '<input type="' + inputType + '" id="' + id + '" value="' + escapeHtml(val) + '"' +
        ' oninput="markChanged()">';
    }

    return '';
  }

  function getValue(setting) {
    const el = document.getElementById('setting-' + setting.key);
    if (!el) return undefined;

    if (setting.type === 'toggle') {
      return el.checked ? 1 : 0;
    }
    if (setting.type === 'enum') {
      return parseInt(el.value, 10);
    }
    if (setting.type === 'value') {
      return parseInt(el.value, 10);
    }
    if (setting.type === 'string') {
      return el.value;
    }
    return undefined;
  }

  function markChanged() {
    document.getElementById('saveBtn').disabled = false;
  }

  async function loadSettings() {
    try {
      // TODO: Uncomment before merge
      // const response = await fetch('/api/settings');
      // if (!response.ok) {
      //   throw new Error('Failed to load settings: ' + response.status);
      // }
      // allSettings = await response.json();
      allSettings = [
        { category: 'Display', key: 'sleep_screen', name: 'Sleep Screen', type: 'enum', options: ['Cover', 'None', 'Dark'], value: 0 },
        { category: 'Display', key: 'sleep_screen_cover_mode', name: 'Sleep Screen Cover Mode', type: 'enum', options: ['Fit', 'Crop'], value: 1 },
        { category: 'Display', key: 'sleep_screen_cover_filter', name: 'Sleep Screen Cover Filter', type: 'enum', options: ['None', 'Grayscale', 'Inverted'], value: 0 },
        { category: 'Reader', key: 'font_family', name: 'Font Family', type: 'enum', options: ['Bookerly'], value: 0 },
        { category: 'Reader', key: 'font_size', name: 'Font Size', type: 'enum', options: ['Small', 'Medium', 'Large'], value: 1 },
        { category: 'Reader', key: 'line_spacing', name: 'Line Spacing', type: 'enum', options: ['Tight', 'Normal', 'Loose'], value: 1 },
        { category: 'Reader', key: 'margin_size', name: 'Screen Margin', type: 'enum', options: ['15'], value: 0 },
        { category: 'Controls', key: 'side_button_layout', name: 'Side Button Layout', type: 'enum', options: ['Prev, Next', 'Next, Prev'], value: 0 },
        { category: 'Controls', key: 'long_press_chapter_skip', name: 'Long Press Chapter Skip', type: 'toggle', value: 1 },
      ];

      // Store original values
      originalValues = {};
      allSettings.forEach(function(s) {
        originalValues[s.key] = s.value;
      });

      // Group by category
      const groups = {};
      allSettings.forEach(function(s) {
        if (!groups[s.category]) groups[s.category] = [];
        groups[s.category].push(s);
      });

      const container = document.getElementById('settings-container');
      let html = '';

      for (const category in groups) {
        html += '<div class="card"><h3>' + escapeHtml(category) + '</h3>';
        groups[category].forEach(function(s) {
          html += '<div class="setting-row">' +
            '<span class="setting-name">' + escapeHtml(s.name) + '</span>' +
            '<span class="setting-control">' + renderControl(s) + '</span>' +
            '</div>';
        });
        html += '</div>';
      }

      container.innerHTML = html;
      document.getElementById('save-container').style.display = '';
      document.getElementById('saveBtn').disabled = true;
    } catch (e) {
      console.error(e);
      document.getElementById('settings-container').innerHTML =
        '<div class="card"><p style="text-align:center;color:#e74c3c;">Failed to load settings</p></div>';
    }
  }

  async function saveSettings() {
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    // Collect only changed values
    const changes = {};
    allSettings.forEach(function(s) {
      const current = getValue(s);
      if (current !== undefined && current !== originalValues[s.key]) {
        changes[s.key] = current;
      }
    });

    if (Object.keys(changes).length === 0) {
      showMessage('No changes to save.', false);
      btn.textContent = 'Save Settings';
      return;
    }

    try {
      const response = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(changes)
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || 'Save failed');
      }

      // Update original values to new values
      for (const key in changes) {
        originalValues[key] = changes[key];
      }

      showMessage('Settings saved successfully!', false);
    } catch (e) {
      console.error(e);
      showMessage('Error: ' + e.message, true);
    }

    btn.textContent = 'Save Settings';
  }

  loadSettings();
</script>
</body>
</html>
