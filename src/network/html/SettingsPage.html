<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrossPoint Reader - Settings</title>
  <style>
    body {
      --font-color: #333;
      --background: #f5f5f5;
      --title-color: #2c3e50;
      --card-background: white;
      --muted-color: #95a5a6;
      --border-color: #eee;
      --accent-color-rgb: 110, 154, 130;
      --accent-color: rgb(var(--accent-color-rgb));
      --accent-color-50: rgba(var(--accent-color-rgb), .5);
      --accent-color-highlight: #5a8c73;
      --toggle-bg: #ccc;

      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Oxygen, Ubuntu, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: var(--background);
      color: var(--font-color);
      font-size: 16px;
    }
    @media (prefers-color-scheme: dark) {
      body {
        --font-color: #f5f5f5;
        --background: #333;
        --title-color: #ecf0f1;
        --card-background: #444;
        --border-color: #555;
        --toggle-bg: #333;

        color-scheme: dark;
      }
    }
    h1 {
      margin-top: 0;
      color: var(--title-color);
      display: flex;
      gap: 8px;
      font-size: 24px;
      align-items: center;
      padding-bottom: 10px;
    }
    h1 .logo {
      background-color: #6e9a82;
      padding: 0 4px;
      border-radius: 4px;
    }
    h1 .logo svg {
      width: 18px;
      height: 18px;
    }
    h2 {
      color: var(--title-color);
      margin-top: 0;
      font-size: 20px;
    }
    .card {
      background: var(--card-background);
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card h3 {
      margin: 0;
      color: var(--title-color);
      font-size: 18px;
      padding-bottom: 8px;
    }
    .nav-links {
      margin: 20px 0 15px;
      border-bottom: solid 2px var(--border-color);
      display: flex;
      gap: 8px;
      padding-bottom: 8px;
    }
    .nav-links a {
      padding: 8px 15px;
      font-size: 0.85em;
      color: var(--font-color);
      text-decoration: none;
      border-radius: 4px;
    }
    .nav-links a.active {
      color: #FFF;
      text-decoration: none;
      background: var(--accent-color);
    }
    .nav-links a:hover {
      color: var(--font-color);
      text-decoration: none;
      background: var(--border-color);
    }
    .nav-links a.active:hover {
      background: var(--accent-color-highlight);
    }
    a {
      color: var(--accent-color);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .setting-row {
      display: flex;
      gap: 6px;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-color);
    }
    .setting-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .setting-control select,
    .setting-control input[type="number"],
    .setting-control input[type="text"],
    .setting-control input[type="password"] {
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.95em;
      background: var(--background);
      border: 1px solid var(--border-color);
    }
    .setting-control input[type="text"],
    .setting-control input[type="password"] {
      width: 220px;
    }
    .setting-control input[type="number"] {
      width: 80px;
    }
    /* Toggle switch */
    .toggle-switch {
      display: inline-block;
      position: relative;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: var(--toggle-bg);
      border-radius: 26px;
      transition: 0.3s;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--accent-color);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .save-container {
      display: flex;
      justify-content: center;
      margin: 20px 0 30px;
    }
    .save-btn {
      background-color: #27ae60;
      color: white;
      padding: 12px 40px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
    }
    .save-btn:hover {
      background-color: #219a52;
    }
    .save-btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    .toast {
      padding: 12px;
      border-radius: 4px;
      display: none;
      position: fixed;
      left: 16px;
      bottom: 16px;
      min-width: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    .toast-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .toast-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .toast-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .loader-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #AAA;
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    .btn {
      color: white;
      padding: 8px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 16px;
      line-height: 1.5;
    }
    .btn-lg {
      padding: 0.5rem 1rem;
      font-size: 1.25rem;
      border-radius: 0.5rem;
    }
    .btn-primary {
      background-color: var(--accent-color);
    }
    .btn-primary:hover {
      background-color: var(--accent-color-highlight);
    }
    .btn-primary:disabled {
      background-color: var(--accent-color-50);
      cursor: not-allowed;
      color: var(--muted-color)
    }
    .btn-secondary {
      background-color: #6c757d;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    footer {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: .85em;
    }
    footer .icon {
      height: 20px;
      width: 20px;
    }
    @keyframes rotation {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @media (max-width: 600px) {
      body {
        padding: 10px;
        font-size: 14px;
      }
      .toast {
        left: 10px;
        bottom: 10px;
        right: 10px;
      }
      .card {
        padding: 12px;
        margin: 10px 0;
      }
      h1 {
        font-size: 1.3em;
      }
      .nav-links a {
        padding: 8px 12px;
        margin-right: 6px;
        font-size: 0.9em;
      }
      .setting-row {
        padding: 4px 0;
        border: none;
      }
      .setting-control select {
        min-width: 0;
        width: 100%;
      }

      .setting-control input[type="text"],
      .setting-control input[type="password"] {
        width: 100px;
      }
      footer {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <h1>
    <span class="logo">
      <svg viewBox="0 0 162 180" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M141.133 1.93774C150.102 -3.44192 161.517 3.01665 161.521 13.4749V166.526C161.517 176.984 150.102 183.442 141.133 178.063L80.7588 141.837L20.3867 178.063C11.4176 183.442 0.00328866 176.984 0 166.526V13.4749C0.00337257 3.01685 11.4176 -3.44137 20.3867 1.93774L80.7598 38.1614L141.133 1.93774ZM121.275 117.524L92.3848 134.864L147.281 167.811C148.277 168.408 149.542 167.685 149.545 166.526V100.567L121.275 117.524ZM14.2393 12.1897C13.2438 11.5924 11.979 12.3152 11.9756 13.4749V86.6125L74.7725 124.29V48.51L14.2393 12.1897Z" fill="black"/>
      </svg>
    </span>
    CrossPoint Reader
  </h1>

  <div class="nav-links">
    <a href="/">Home</a>
    <a href="/files">File Manager</a>
    <a href="/settings" class="active">Settings</a>
  </div>

  <h2>Settings</h2>

  <div id="toast" class="toast toast-info"></div>

  <div id="settings-container">
    <div class="loader-container">
      <span class="loader"></span>
    </div>
  </div>

  <div class="save-container" id="save-container" style="display:none;">
    <button class="btn btn-lg btn-primary" id="saveBtn" onclick="saveSettings(event)">Save Settings</button>
  </div>

  <footer>
    <svg class="icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path fill="currentColor" d="M12,2A10,10,0,0,0,8.84,21.5c.5.08.66-.23.66-.5V19.31C6.73,19.91,6.14,18,6.14,18A2.69,2.69,0,0,0,5,16.5c-.91-.62.07-.6.07-.6a2.1,2.1,0,0,1,1.53,1,2.15,2.15,0,0,0,2.91.83,2.16,2.16,0,0,1,.63-1.34C8,16.17,5.62,15.31,5.62,11.5a3.87,3.87,0,0,1,1-2.71,3.58,3.58,0,0,1,.1-2.64s.84-.27,2.75,1a9.63,9.63,0,0,1,5,0c1.91-1.29,2.75-1,2.75-1a3.58,3.58,0,0,1,.1,2.64,3.87,3.87,0,0,1,1,2.71c0,3.82-2.34,4.66-4.57,4.91a2.39,2.39,0,0,1,.69,1.85V21c0,.27.16.59.67.5A10,10,0,0,0,12,2Z"></path>
    </svg>
    <a
      href="https://github.com/crosspoint-reader/crosspoint-reader"
      target="_blank"
      >CrossPoint E-Reader â€¢ Open Source</a
    >
  </footer>

<script>
  let allSettings = [];
  let originalValues = {};
  const VALID_SETTING_TYPES = ['toggle', 'enum', 'value', 'string'];

  function escapeHtml(unsafe) {
    return unsafe
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function showToast(text, type = "info") {
    const toast = document.getElementById('toast');
    toast.textContent = text;
    toast.className = 'toast toast-' + type;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 4000);
  }

  function renderControl(setting) {
    const id = 'setting-' + setting.key;

    if (setting.type === 'toggle') {
      const checked = setting.value ? 'checked' : '';
      return '<label class="toggle-switch">' +
        '<input type="checkbox" id="' + id + '" ' + checked + ' onchange="markChanged()">' +
        '<span class="toggle-slider"></span></label>';
    }

    if (setting.type === 'enum') {
      let html = '<select id="' + id + '" onchange="markChanged()">';
      setting.options.forEach(function(opt, idx) {
        const selected = idx === setting.value ? ' selected' : '';
        html += '<option value="' + idx + '"' + selected + '>' + escapeHtml(opt) + '</option>';
      });
      html += '</select>';
      return html;
    }

    if (setting.type === 'value') {
      return '<input type="number" id="' + id + '" value="' + setting.value + '"' +
        ' min="' + setting.min + '" max="' + setting.max + '" step="' + setting.step + '"' +
        ' onchange="markChanged()">';
    }

    if (setting.type === 'string') {
      const inputType = setting.name.toLowerCase().includes('password') ? 'password' : 'text';
      const val = setting.value || '';
      return '<input type="' + inputType + '" id="' + id + '" value="' + escapeHtml(val) + '"' +
        ' oninput="markChanged()">';
    }
  }

  function getValue(setting) {
    const el = document.getElementById('setting-' + setting.key);
    if (!el) return undefined;

    switch (setting.type) {
      case 'toggle':
        return el.checked ? 1 : 0;
      case 'enum': case 'value':
        return parseInt(el.value, 10);
      case 'string':
        return el.value;
      default:
        return undefined;
    }
  }

  function markChanged() {
    document.getElementById('saveBtn').disabled = false;
  }

  async function loadSettings() {
    try {
      const response = await fetch('/api/settings');
      if (!response.ok) {
        throw new Error('Failed to load settings: ' + response.status);
      }
      allSettings = await response.json();

      // Store original values
      originalValues = {};
      allSettings.forEach(function(s) {
        originalValues[s.key] = s.value;
      });

      // Group by category
      const groups = {};
      allSettings.forEach(function(s) {
        if (!groups[s.category]) groups[s.category] = [];
        groups[s.category].push(s);
      });

      const container = document.getElementById('settings-container');
      let html = '';

      for (const category in groups) {
        html += '<div class="card"><h3>' + escapeHtml(category) + '</h3>';
        groups[category].forEach(function(s) {
          if (!VALID_SETTING_TYPES.includes(s.type)) return;

          html += '<div class="setting-row">' +
            '<span class="setting-name">' + escapeHtml(s.name) + '</span>' +
            '<span class="setting-control">' + renderControl(s) + '</span>' +
            '</div>';
        });
        html += '</div>';
      }

      container.innerHTML = html;
      document.getElementById('save-container').style.display = '';
      document.getElementById('saveBtn').disabled = true;
    } catch (e) {
      console.error(e);
      document.getElementById('settings-container').innerHTML =
        '<div class="card"><p style="text-align:center;color:#e74c3c;">Failed to load settings</p></div>';
    }
  }

  async function saveSettings(event) {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Saving...';

    // Collect only changed values
    const changes = {};
    allSettings.forEach(function(s) {
      const current = getValue(s);
      if (current !== undefined && current !== originalValues[s.key]) {
        changes[s.key] = current;
      }
    });

    if (Object.keys(changes).length === 0) {
      showToast('No changes to save.');
      btn.textContent = 'Save Settings';
      return;
    }

    try {
      const response = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(changes)
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(text || 'Save failed');
      }

      // Update original values to new values
      for (const key in changes) {
        originalValues[key] = changes[key];
      }

      showToast('Settings saved successfully!', "success");
    } catch (e) {
      console.error(e);
      showToast('Error: ' + e.message, "error");
    }

    btn.textContent = 'Save Settings';
  }

  loadSettings();
</script>
</body>
</html>
